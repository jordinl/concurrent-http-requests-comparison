#!/usr/bin/env sh

credentials=$1

ssh -T -o StrictHostKeyChecking=no "$credentials" << EOF
    sudo apt update
    sudo apt install -y p7zip git build-essential pkg-config libssl-dev

    arch=\$(dpkg --print-architecture)
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
    curl -fsSL https://deno.land/install.sh | sh
    curl -L "https://go.dev/dl/go1.22.5.linux-\${arch}.tar.gz" -o /tmp/go.tar.gz
    sudo tar -C /usr/local -xzf /tmp/go.tar.gz
    rm /tmp/go.tar.gz

    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

    echo 'export PATH=\$PATH:/usr/local/go/bin' >> ~/.bashrc
    echo 'export PATH=\$PATH:\$HOME/.deno/bin' >> ~/.bashrc

    echo 'UV_THREADPOOL_SIZE=20' >> ~/.bashrc

    mkdir app
    cd app

    git config --global init.defaultBranch main
    git config --global receive.denyCurrentBranch updateInstead
    git init
EOF

git remote remove server
git remote add server "$credentials:app"
git push --all

ssh -t "$credentials" bash -i << EOF
    nvm install 20

    cd app

    npm install --prefix node-fetch
    npm install --prefix superagent

    go mod download -C gocolly
    go build -C gocolly -v crawl.go

    go build -C gohttp -v crawl.go

    rustc rust-reqwest/crawl.rs --out-dir rust-reqwest
EOF
